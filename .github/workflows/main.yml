name: 'The Forge - AI Engineer'

on:
  workflow_dispatch:
    inputs:
      engine_choice:
        description: 'The AI engine to use'
        required: true
        type: string
      user_ai_api_key:
        description: 'The API key for the selected AI engine'
        required: true
        type: string
      target_owner:
        description: 'The owner of the target repository'
        required: true
        type: string
      target_repo:
        description: 'The name of the target repository'
        required: true
        type: string
      prompt:
        description: 'The user-defined prompt for the AI engineer'
        required: true
        type: string

jobs:
  ai_engineer_job:
    name: 'ğŸ¤– AI Engineer is working...'
    runs-on: ubuntu-latest
    steps:
      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
      # ---------------------------------------------------------------
      - name: 'ğŸ“¥ 1. Receiving instructions'
        run: |
          echo "âœ… Instructions received."
          echo "ğŸ§  AI Engine: ${{ github.event.inputs.engine_choice }}"
          echo "ğŸ¯ Target: ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}"
          echo "âš¡ Prompt: ${{ github.event.inputs.prompt }}"

      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù
      # ---------------------------------------------------------------
      - name: 'ğŸ“‚ 2. Cloning target repository'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}
          path: 'target_repo' # Ø§Ø³ØªÙ†Ø³Ø§Ø® ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ
          token: ${{ secrets.GITHUB_TOKEN }} # Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙˆÙƒÙ† GitHub Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª

      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø¨Ø§ÙŠØ«ÙˆÙ†
      # ---------------------------------------------------------------
      - name: 'ğŸ 3. Setting up Python environment'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 'ğŸ“¦ Installing libraries'
        run: pip install requests

      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø°ÙƒÙŠ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©)
      # ---------------------------------------------------------------
      - name: 'ğŸš€ 4. Running The Smart Script (Create File Task)'
        env:
          ENGINE_CHOICE: ${{ github.event.inputs.engine_choice }}
          AI_API_KEY: ${{ github.event.inputs.user_ai_api_key }}
          TARGET_OWNER: ${{ github.event.inputs.target_owner }}
          TARGET_REPO: ${{ github.event.inputs.target_repo }}
          USER_PROMPT: ${{ github.event.inputs.prompt }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > engineer_script.py
          import os
          import requests
          import json
          import re
          import subprocess

          # --- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
          api_key = os.getenv('AI_API_KEY')
          prompt = os.getenv('USER_PROMPT')
          target_repo_path = 'target_repo'

          print("--- Starting AI Engineer Script (Create File Task) ---")

          # --- Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ OpenRouter ---
          def call_openrouter(model, messages):
              print("Calling OpenRouter...")
              try:
                  response = requests.post(
                      url="https://openrouter.ai/api/v1/chat/completions",
                      headers={
                          "Authorization": f"Bearer {api_key}",
                          "Content-Type": "application/json",
                          "HTTP-Referer": "https://github.com/sshfkdgb-crypto/Project-Singularity",
                          "X-Title": "The Forge AI Engineer"
                      },
                      data=json.dumps({"model": model, "messages": messages})
                  )
                  response.raise_for_status()
                  print("AI response received.")
                  return response.json()['choices'][0]['message']['content']
              except requests.exceptions.RequestException as e:
                  print(f"Error calling AI API: {e}")
                  if e.response:
                      print(f"Status Code: {e.response.status_code}, Body: {e.response.text}")
                  return None

          # --- Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
          # 1. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰
          print("\n--- Phase 1: Understanding the request ---")
          analysis_prompt = f"""
          Analyze the following user request and extract two pieces of information in JSON format:
          1. 'filename': The name of the file to be created (e.g., 'README.md', 'config.json', 'src/utils.js').
          2. 'content_prompt': A clear and direct prompt for another AI to generate the content of that file.

          User Request: "{prompt}"

          Example:
          User Request: "Create a README.md file that describes the project."
          JSON Output: {{"filename": "README.md", "content_prompt": "Generate the full markdown content for a README.md file that describes a project called 'AI-APP-FACTORY'."}}
          
          Now, analyze the user request above and provide only the JSON output.
          """
          
          analysis_messages = [{"role": "user", "content": analysis_prompt}]
          analysis_response = call_openrouter(model="deepseek/deepseek-coder", messages=analysis_messages)

          if not analysis_response:
              print("âŒ Failed to analyze the prompt. Exiting.")
              exit(1)

          try:
              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù€ AI
              json_str = re.search(r'\{.*\}', analysis_response, re.DOTALL).group()
              task_details = json.loads(json_str)
              filename = task_details['filename']
              content_prompt = task_details['content_prompt']
              print(f"AI decided to create file: '{filename}'")
          except (AttributeError, json.JSONDecodeError) as e:
              print(f"âŒ Could not parse JSON from AI analysis: {e}")
              print(f"Raw response was: {analysis_response}")
              exit(1)

          # 2. ØªÙˆÙ„ÙŠØ¯ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          print("\n--- Phase 2: Generating file content ---")
          content_messages = [
              {"role": "system", "content": "You are a file content generator. You only output the raw text/code for the requested file, without any explanations or pleasantries."},
              {"role": "user", "content": content_prompt}
          ]
          file_content = call_openrouter(model="deepseek/deepseek-coder", messages=content_messages)

          if not file_content:
              print("âŒ Failed to generate file content. Exiting.")
              exit(1)

          # 3. ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù
          print(f"\n--- Phase 3: Writing file '{filename}' ---")
          file_path = os.path.join(target_repo_path, filename)
          os.makedirs(os.path.dirname(file_path), exist_ok=True) # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
          with open(file_path, 'w', encoding='utf-8') as f:
              f.write(file_content)
          print("File written successfully.")

          # 4. Ø¥Ø¹Ø¯Ø§Ø¯ Git ÙˆØ¥Ù†Ø´Ø§Ø¡ Pull Request (Ø®Ø·ÙˆØ§Øª Ù…Ø¨Ø³Ø·Ø©)
          print("\n--- Phase 4: Creating Pull Request ---")
          try:
              branch_name = f"ai-engineer/create-{filename.replace('.', '-')}"
              subprocess.run(['git', 'config', '--global', 'user.name', 'The Forge AI'], cwd=target_repo_path, check=True)
              subprocess.run(['git', 'config', '--global', 'user.email', 'ai-forge@example.com'], cwd=target_repo_path, check=True)
              subprocess.run(['git', 'checkout', '-b', branch_name], cwd=target_repo_path, check=True)
              subprocess.run(['git', 'add', '.'], cwd=target_repo_path, check=True)
              subprocess.run(['git', 'commit', '-m', f"feat: Create {filename} as requested"], cwd=target_repo_path, check=True)
              # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ù…Ø± push ÙŠØªØ·Ù„Ø¨ ØªÙˆÙƒÙ† Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØªØ§Ø¨Ø©. Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…Ø¯Ù…Ø¬ Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙÙŠ.
              # subprocess.run(['git', 'push', 'origin', branch_name], cwd=target_repo_path, check=True)
              print("âœ… Git commit created successfully on new branch.")
              print(f"Next step would be to push the branch '{branch_name}' and create a Pull Request.")
              print("For now, the changes exist only in this runner.")

          except subprocess.CalledProcessError as e:
              print(f"âŒ Git operation failed: {e}")
              exit(1)

          print("\nâœ…âœ…âœ… AI Engineer task completed successfully! âœ…âœ…âœ…")

          EOF

          python engineer_script.py
