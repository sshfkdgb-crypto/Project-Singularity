name: 'The Forge - AI Engineer'

# ===================================================================
# 1. TRIGGER: ÙƒÙŠÙ ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠ
# ===================================================================
# Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠ ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ù€ API
# (Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Forge Optimizer)
on:
  workflow_dispatch:
    inputs:
      # Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ±Ø³Ù„Ù‡Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      engine_choice:
        description: 'The AI engine to use (gemini or openrouter)'
        required: true
        type: string
      user_ai_api_key:
        description: 'The user-provided API key for the selected AI engine'
        required: true
        type: string
      target_owner:
        description: 'The owner of the target repository'
        required: true
        type: string
      target_repo:
        description: 'The name of the target repository'
        required: true
        type: string
      prompt:
        description: 'The user-defined prompt for the AI engineer'
        required: true
        type: string

# ===================================================================
# 2. JOBS: Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§
# ===================================================================
jobs:
  ai_engineer_job:
    # Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙŠ Ø³ØªØ¸Ù‡Ø± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© GitHub Actions
    name: 'ğŸ¤– AI Engineer is thinking...'
    
    # Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø°ÙŠ Ø³ØªØ¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù…Ù‡Ù…Ø©
    runs-on: ubuntu-latest

    # ===============================================================
    # 3. STEPS: Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© Ù„Ù„Ù…Ù‡Ù…Ø©
    # ===============================================================
    steps:
      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØµÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)
      # ---------------------------------------------------------------
      - name: 'ğŸ“¥ 1. Receiving instructions from The Forge App'
        run: |
          echo "âœ… Instructions received successfully."
          echo "ğŸ§  AI Engine selected: ${{ github.event.inputs.engine_choice }}"
          echo "ğŸ¯ Target repository: ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}"
          echo "âš¡ User prompt: ${{ github.event.inputs.prompt }}"

      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„ (ØªØ«Ø¨ÙŠØª Python)
      # ---------------------------------------------------------------
      - name: 'ğŸ› ï¸ 2. Setting up the environment'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø®Ø© Ø­Ø¯ÙŠØ«Ø© Ù…Ù† Ø¨Ø§ÙŠØ«ÙˆÙ†

      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      # ---------------------------------------------------------------
      - name: 'ğŸ“¦ 3. Installing necessary libraries'
        run: |
          pip install requests # Ù…ÙƒØªØ¨Ø© Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø·Ù„Ø¨Ø§Øª HTTP
          # ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø§Øª Ø£Ø®Ø±Ù‰ Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù…Ø«Ù„ PyGithub

      # ---------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 4: ÙƒØªØ§Ø¨Ø© ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø°ÙƒÙŠ
      # ---------------------------------------------------------------
      - name: 'ğŸš€ 4. Running the Smart Script'
        env:
          # ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙƒÙ…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦Ø© (Environment Variables) Ù„Ù„Ø³ÙƒØ±Ø¨Øª
          ENGINE_CHOICE: ${{ github.event.inputs.engine_choice }}
          AI_API_KEY: ${{ github.event.inputs.user_ai_api_key }}
          TARGET_OWNER: ${{ github.event.inputs.target_owner }}
          TARGET_REPO: ${{ github.event.inputs.target_repo }}
          USER_PROMPT: ${{ github.event.inputs.prompt }}
          # Ø³Ù†Ø­ØªØ§Ø¬ Ø£ÙŠØ¶Ù‹Ø§ Ø¥Ù„Ù‰ ØªÙˆÙƒÙ† GitHub Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù
          # Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…Ø¯Ù…Ø¬ ÙÙŠ GitHub Actions Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ÙƒØªØ§Ø¨Ø© Ø³ÙƒØ±Ø¨Øª Ø¨Ø§ÙŠØ«ÙˆÙ† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§
          cat << 'EOF' > engineer_script.py
          import os
          import requests
          import json

          # --- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„ ---
          engine = os.getenv('ENGINE_CHOICE')
          api_key = os.getenv('AI_API_KEY')
          target_owner = os.getenv('TARGET_OWNER')
          target_repo = os.getenv('TARGET_REPO')
          prompt = os.getenv('USER_PROMPT')
          github_token = os.getenv('GITHUB_TOKEN')

          print(f"--- Starting AI Engineer Script ---")
          print(f"Engine: {engine}")
          print(f"Target: {target_owner}/{target_repo}")

          # --- Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø§Ù„Ù€ API ---
          def call_ai_engine(model, messages):
              headers = {"Authorization": f"Bearer {api_key}"}
              api_url = ""
              
              if engine == 'openrouter':
                  print("Using OpenRouter...")
                  api_url = "https://openrouter.ai/api/v1/chat/completions"
                  headers["Content-Type"] = "application/json"
                  data = {
                      "model": model,
                      "messages": messages
                  }
              elif engine == 'gemini':
                  print("Using Google Gemini...")
                  # Ù…Ù„Ø§Ø­Ø¸Ø©: ÙƒÙˆØ¯ Gemini API ÙŠØ®ØªÙ„Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ù…Ø¨Ø³Ø·
                  # Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…ÙƒØªØ¨Ø© google-generativeai Ù„ØªÙØ¹ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                  api_url = f"https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={api_key}"
                  headers = {"Content-Type": "application/json"}
                  # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø³Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Gemini
                  gemini_messages = [{"role": "user", "parts": [{"text": m["content"]}] for m in messages}]
                  data = {"contents": gemini_messages}
              else:
                  print(f"Error: Unknown engine '{engine}'")
                  return None

              try:
                  response = requests.post(api_url, headers=headers, data=json.dumps(data))
                  response.raise_for_status() # ÙŠØ·Ù„Ù‚ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®Ø·Ø£ (4xx, 5xx)
                  
                  print("AI response received successfully.")
                  # Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù†Øµ ÙŠØ®ØªÙ„Ù Ø¨ÙŠÙ† Ø§Ù„Ù€ APIs
                  if engine == 'openrouter':
                      return response.json()['choices'][0]['message']['content']
                  elif engine == 'gemini':
                      return response.json()['candidates'][0]['content']['parts'][0]['text']

              except requests.exceptions.RequestException as e:
                  print(f"Error calling AI API: {e}")
                  print(f"Response Body: {e.response.text if e.response else 'No response'}")
                  return None

          # --- Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø«Ø§Ù„ Ù…Ø¨Ø³Ø·) ---
          # ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø³ØªÙ‚ÙˆÙ… Ø¨Ù€:
          # 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù.
          # 2. Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ù„ÙØ§Øª.
          # 3. Ø¨Ù†Ø§Ø¡ Ø¨Ø±ÙˆÙ…Ø¨Øª Ù…ÙØµÙ„.
          # 4. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.
          # 5. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.
          # 6. Ø¥Ù†Ø´Ø§Ø¡ Pull Request.

          print("\n--- Phase 1: Simple AI Task ---")
          print("Task: Ask the AI to introduce itself based on the prompt.")

          # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø±Ùƒ
          model_name = "deepseek/deepseek-coder" if engine == 'openrouter' else "gemini-1.5-flash-latest"

          # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù€ AI
          message_list = [
              {"role": "system", "content": "You are an expert AI software engineer. Your task is to analyze user requests and provide code or explanations."},
              {"role": "user", "content": f"Based on this user command: '{prompt}', briefly introduce what you are about to do."}
          ]

          # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø­Ø±Ùƒ
          ai_response = call_ai_engine(model=model_name, messages=message_list)

          if ai_response:
              print("\n--- AI Introduction ---")
              print(ai_response)
              print("-----------------------\n")
              print("âœ… Script finished successfully.")
          else:
              print("\nâŒ Script failed to get a response from the AI.")

          EOF

          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡
          python engineer_script.py
