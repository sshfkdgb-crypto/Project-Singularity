name: 'The Forge - AI Engineer'

on:
  workflow_dispatch:
    inputs:
      engine_choice:
        description: 'The AI engine to use (gemini or openrouter)'
        required: true
        type: string
      user_ai_api_key:
        description: 'The user-provided API key for the selected AI engine'
        required: true
        type: string
      target_owner:
        description: 'The owner of the target repository'
        required: true
        type: string
      target_repo:
        description: 'The name of the target repository'
        required: true
        type: string
      prompt:
        description: 'The user-defined prompt for the AI engineer'
        required: true
        type: string

jobs:
  ai_engineer_job:
    name: 'ğŸ¤– AI Engineer is thinking...'
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ“¥ 1. Receiving instructions from The Forge App'
        run: |
          echo "âœ… Instructions received successfully."
          echo "ğŸ§  AI Engine selected: ${{ github.event.inputs.engine_choice }}"
          echo "ğŸ¯ Target repository: ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}"
          echo "âš¡ User prompt: ${{ github.event.inputs.prompt }}"

      - name: 'ğŸ› ï¸ 2. Setting up the environment'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 'ğŸ“¦ 3. Installing necessary libraries'
        run: |
          pip install requests

      - name: 'ğŸš€ 4. Running the Smart Script'
        env:
          ENGINE_CHOICE: ${{ github.event.inputs.engine_choice }}
          AI_API_KEY: ${{ github.event.inputs.user_ai_api_key }}
          TARGET_OWNER: ${{ github.event.inputs.target_owner }}
          TARGET_REPO: ${{ github.event.inputs.target_repo }}
          USER_PROMPT: ${{ github.event.inputs.prompt }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > engineer_script.py
          import os
          import requests
          import json

          # --- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
          engine = os.getenv('ENGINE_CHOICE')
          api_key = os.getenv('AI_API_KEY')
          target_owner = os.getenv('TARGET_OWNER')
          target_repo = os.getenv('TARGET_REPO')
          prompt = os.getenv('USER_PROMPT')

          print(f"--- Starting AI Engineer Script ---")
          print(f"Engine: {engine}")
          print(f"Target: {target_owner}/{target_repo}")

          # --- Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø­Ø±Ùƒ ---
          def call_ai_engine(model, messages):
              if engine != 'openrouter':
                  print(f"Error: This script currently only supports 'openrouter'. You selected '{engine}'.")
                  return None

              print("Using OpenRouter...")
              api_url = "https://openrouter.ai/api/v1/chat/completions"
              
              # âœ…âœ…âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ØªÙ… ØªØµØ­ÙŠØ­Ù‡ âœ…âœ…âœ…
              # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ù‚Ø¨Ù„ OpenRouter
              headers = {
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json",
                  "HTTP-Referer": f"https://github.com/{target_owner}/{target_repo}", # Ø£ÙŠ Ø±Ø§Ø¨Ø· Ù…Ù‚Ø¨ÙˆÙ„
                  "X-Title": "The Forge AI Engineer" # Ø§Ø³Ù… ÙˆØµÙÙŠ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ
              }
              
              data = {
                  "model": model,
                  "messages": messages
              }

              try:
                  response = requests.post(api_url, headers=headers, data=json.dumps(data))
                  response.raise_for_status()
                  print("AI response received successfully.")
                  return response.json()['choices'][0]['message']['content']

              except requests.exceptions.RequestException as e:
                  print(f"Error calling AI API: {e}")
                  if e.response:
                      print(f"Status Code: {e.response.status_code}")
                      print(f"Response Body: {e.response.text}")
                  return None

          # --- Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
          print("\n--- Phase 1: Simple AI Task ---")
          print("Task: Ask the AI to introduce itself based on the prompt.")

          model_name = "deepseek/deepseek-coder"
          message_list = [
              {"role": "system", "content": "You are an expert AI software engineer. Your task is to analyze user requests and provide code or explanations."},
              {"role": "user", "content": f"Based on this user command: '{prompt}', briefly introduce what you are about to do."}
          ]

          ai_response = call_ai_engine(model=model_name, messages=message_list)

          if ai_response:
              print("\n--- AI Introduction ---")
              print(ai_response)
              print("-----------------------\n")
              print("âœ… Script finished successfully.")
          else:
              print("\nâŒ Script failed to get a response from the AI.")
              exit(1)

          EOF

          python engineer_script.py
