name: ğŸ¤– Ultimate Forge Pro - The AI Engineer

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
      target_repo:
        description: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
      target_token:
        description: 'GitHub PAT (ØµÙ„Ø§Ø­ÙŠØ§Øª workflow Ùˆ repo)'
        required: true
      improvement_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†'
        required: true
        default: 'all'
      custom_command:
        description: 'Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Forge Optimizer'
        required: true

jobs:
  total-control-execution:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø´Ø§Ù…Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ÙÙŠØ©)
        run: |
          set -e
          git clone "https://x-access-token:${{ github.event.inputs.target_token }}@github.com/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}.git" workspace
          cd workspace
          git config --global user.name "Genesis Forge AI"
          git config --global user.email "ai@genesis-forge.com"

      - name: ğŸ” Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ .github)
        run: |
          cd workspace
          # ØªØµØ­ÙŠØ­ Ø£Ù…Ø± find Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù‚ÙˆØ§Ø³ Ù„Ø¶Ø¨Ø· Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
          find . -maxdepth 4 \( -not -path '*/.*' -o -path './.github*' \) > ../full_structure.txt

      - name: ğŸ¤– ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
        run: |
          cat << 'EOF' > ai_response.json
          {
            "summary": "ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±: ${{ github.event.inputs.custom_command }}",
            "plan": [
              {
                "action": "modify",
                "file_path": ".github/workflows/repo-optimizer.yml",
                "original_code": "timeout-minutes: 30",
                "suggested_code": "timeout-minutes: 60"
              },
              {
                "action": "create",
                "file_path": "FORGE_LOG.md",
                "content": "# Ø³Ø¬Ù„ Forge Optimizer\nØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±: ${{ github.event.inputs.custom_command }}"
              }
            ]
          }
          EOF

      - name: âš™ï¸ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„)
        run: |
          sudo apt-get update && sudo apt-get install -y jq python3
          cd workspace
          
          jq -c '.plan[]' ../ai_response.json | while read -r step; do
            ACTION=$(echo "$step" | jq -r '.action')
            FILE_PATH=$(echo "$step" | jq -r '.file_path')
            
            echo "â–¶ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: $FILE_PATH"
            
            if [ "$ACTION" = "create" ]; then
              mkdir -p "$(dirname "$FILE_PATH")"
              echo "$step" | jq -r '.content' > "$FILE_PATH"
              
            elif [ "$ACTION" = "modify" ]; then
              ORIG=$(echo "$step" | jq -r '.original_code')
              SUGG=$(echo "$step" | jq -r '.suggested_code')
              
              echo "import sys, os
path, orig, sugg = sys.argv[1], sys.argv[2], sys.argv[3]
if os.path.exists(path):
    with open(path, 'r', encoding='utf-8') as f:
        content = f.read()
    if orig in content:
        with open(path, 'w', encoding='utf-8') as f:
            f.write(content.replace(orig, sugg))
        print(f'âœ… Modified: {path}')
    else:
        print(f'âš ï¸ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ {path}')
" > ../modifier.py
              
              python3 ../modifier.py "$FILE_PATH" "$ORIG" "$SUGG"

            elif [ "$ACTION" = "delete" ]; then
              rm -f "$FILE_PATH"
              echo "ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù: $FILE_PATH"
            fi
          done

      - name: ğŸš€ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯ + PR)
        run: |
          cd workspace
          BRANCH="forge-update-${{ github.run_id }}"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "ğŸ¤– [Genesis Forge Pro]: ${{ github.event.inputs.custom_command }}" || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª"
          git push origin "$BRANCH"

      - name: ğŸ”€ ÙØªØ­ Pull Request ØªÙ„Ù‚Ø§Ø¦ÙŠ
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.event.inputs.target_token }}
          commit-message: "ğŸ¤– [Genesis Forge Pro]: ${{ github.event.inputs.custom_command }}"
          branch: forge-update-${{ github.run_id }}
          title: "ğŸ¤– ØªØ­Ø³ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${{ github.event.inputs.custom_command }}"
          body: |
            Ù‡Ø°Ø§ Ø§Ù„Ù€ PR ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ultimate Forge Pro.
            - Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù…Ù†ÙØ°: `${{ github.event.inputs.custom_command }}`
            - Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†: `${{ github.event.inputs.improvement_type }}`
            - Ø³Ø¬Ù„ Ø§Ù„ØªÙ†ÙÙŠØ° Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ `FORGE_LOG.md`.
